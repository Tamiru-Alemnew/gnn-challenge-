name: Score Submission

on:
  pull_request:
    branches:
      - main
    paths:
      - 'submissions/inbox/**'

  workflow_dispatch:
    inputs:
      submission_path:
        description: 'Path to submission directory (e.g., submissions/inbox/team/run_001)'
        required: true
        type: string

jobs:
  validate-submission:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Detect submission path
        id: detect_submission
        run: |
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD | grep "^submissions/inbox/" || echo "")
          if [ -z "$CHANGED_FILES" ]; then
            echo "No submission files changed"
            exit 0
          fi
          SUBMISSION_DIR=$(echo "$CHANGED_FILES" | head -n1 | sed 's|submissions/inbox/\([^/]*/[^/]*\)/.*|\1|')
          SUBMISSION_PATH="submissions/inbox/$SUBMISSION_DIR"
          echo "submission_path=$SUBMISSION_PATH" >> $GITHUB_OUTPUT
          echo "Found submission: $SUBMISSION_PATH"

      - name: Validate submission
        if: steps.detect_submission.outputs.submission_path != ''
        run: |
          SUBMISSION_PATH="${{ steps.detect_submission.outputs.submission_path }}"
          echo "Validating submission at: $SUBMISSION_PATH"
          python competition/validate_submission.py "$SUBMISSION_PATH"

  manual-score:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    env:
      SUBMISSION_PRIVATE_KEY: ${{ secrets.SUBMISSION_PRIVATE_KEY }}
      TEST_LABELS: ${{ secrets.TEST_LABELS }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prepare ground truth labels
        run: |
          mkdir -p data/private
          echo "$TEST_LABELS" | base64 -d > data/private/test_labels.csv

      - name: Decrypt submission
        run: |
          SUBMISSION_PATH="${{ github.event.inputs.submission_path }}"
          echo "Decrypting submission at: $SUBMISSION_PATH"
          python competition/decrypt_submission.py \
            --input "$SUBMISSION_PATH/predictions.enc" \
            --output "$SUBMISSION_PATH/predictions.csv"

      - name: Score submission
        id: score
        run: |
          SUBMISSION_PATH="${{ github.event.inputs.submission_path }}"
          echo "Scoring submission at: $SUBMISSION_PATH"
          python competition/score_submission.py \
            "$SUBMISSION_PATH" \
            data/private/test_labels.csv > score_output.txt
          RESULTS_FILE="$SUBMISSION_PATH/results.json"
          if [ -f "$RESULTS_FILE" ]; then
            F1_SCORE=$(python -c "import json; print(json.load(open('$RESULTS_FILE'))['metrics']['f1_score'])")
            TEAM_NAME=$(python -c "import json; print(json.load(open('$RESULTS_FILE'))['metadata'].get('team_name', 'Unknown'))")
            METHOD=$(python -c "import json; print(json.load(open('$RESULTS_FILE'))['metadata'].get('method', 'Unknown'))")
            echo "f1_score=$F1_SCORE" >> $GITHUB_OUTPUT
            echo "team_name=$TEAM_NAME" >> $GITHUB_OUTPUT
            echo "method=$METHOD" >> $GITHUB_OUTPUT
          fi

      - name: Update leaderboard
        if: steps.score.outputs.f1_score != ''
        run: |
          TEAM="${{ steps.score.outputs.team_name }}"
          METHOD="${{ steps.score.outputs.method }}"
          SCORE="${{ steps.score.outputs.f1_score }}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          echo "${TEAM},${METHOD},${SCORE},${TIMESTAMP}" >> leaderboard/leaderboard.csv

          python3 << 'PYTHON_SCRIPT'
          import pandas as pd
          df = pd.read_csv('leaderboard/leaderboard.csv',
                           names=['team','method','score','timestamp'],
                           header=0)
          df = df.sort_values(['score', 'timestamp'], ascending=[False, True])
          df['rank'] = df['score'].rank(method='dense', ascending=False).astype(int)
          df = df[['rank','team','method','score','timestamp']]
          df.to_csv('leaderboard/leaderboard.csv', index=False)
          PYTHON_SCRIPT

          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add leaderboard/leaderboard.csv
          git commit -m "Update leaderboard: ${TEAM} - F1: ${SCORE}" || echo "No changes to commit"
          git push || echo "Push failed (check permissions)"




